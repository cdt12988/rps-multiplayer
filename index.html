<!DOCTYPE HTML>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<title>RPS-Multiplayer</title>
	<link rel="stylesheet" href="assets/css/reset.css">
	<link rel="stylesheet" href="assets/css/style.css">
	<script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
	<script src="https://www.gstatic.com/firebasejs/5.3.0/firebase.js"></script>
<!--	<script src="assets/js/game.js" defer></script>		-->
	
</head>

<body>
	<header role="banner">
		<h1>Rock Paper Scissors</h1>
	</header>
	
	<div class="game-container">
		
		<div class="new-player">
			<input type="text" id="player-input">
			<div class="btn play" id="play">Play</div>
		</div>
		
		<div class="game-message js-hidden">
			<div class="message" id="msg-1"></div>
			<div class="message" id="msg-2"></div>
		</div>
		
		<div class="player js-hidden" id="one">
			<h2 class="name" id="name1">Player One</h2>
			<div id="choices1" class="js-hidden">
				<div class="choice1">Rock</div>
				<div class="choice1">Paper</div>
				<div class="choice1">Scissors</div>
			</div>
			<div id="p1-waiting" class="js-hidden"><span id="p1-opponent">Waiting...</span></div>
			<div class="win-counter">Wins: <span id="wins1"></span></div>
			<div class="win-counter">Losses: <span id="losses1"></span></div>
		</div>
		<div class="player js-hidden" id="missing1">
			<h2 class="name waiting" id="p1-missing">Waiting for new oppenent...</h2>
		</div>
		
		<div class="results">
			
		</div>
		
		<div class="player js-hidden" id="two">
			<h2 class="name" id="name2">Player Two</h2>
			<div class="js-hidden" id="choices2">
				<div class="choice2">Rock</div>
				<div class="choice2">Paper</div>
				<div class="choice2">Scissors</div>
			</div>
			<div id="p2-waiting" class="js-hidden"><span id="p2-opponent">Waiting...</span></div>
			<div class="win-counter">Wins: <span id="wins2"></span></div>
			<div class="win-counter">Losses: <span id="losses2"></span></div>
		</div>
		<div class="player js-hidden" id="missing2">
			<h2 class="name waiting" id="p2-missing">Waiting for new oppenent...</h2>
		</div>
	
		<div class="chat">
			<div class="chatbox"></div>
			<div class="chat-input-container">
				<input type="text" id="chat-input">
				<div class="btn submit" id="send">Send</div>
			</div>
		</div>
		
	</div>
	
</body>

<script>

//	Initialize Firebase
var config = {
	apiKey: "AIzaSyDtuBaN3MHCbEsw5l2tAnAuOYZOx6ZAgcs",
	authDomain: "twoplayerrps-4bb3a.firebaseapp.com",
	databaseURL: "https://twoplayerrps-4bb3a.firebaseio.com",
	projectId: "twoplayerrps-4bb3a",
	storageBucket: "twoplayerrps-4bb3a.appspot.com",
	messagingSenderId: "869967842169"
};

firebase.initializeApp(config);

var db = firebase.database();

//	Declare Global Variables
var player1Exists = false;
var player1Object;
var player1Name = '';
var player1Choice = '';
var p1Choice = '';
var player2Exists = false;
var player2Object;
var player2Name = '';
var player2Choice = '';
var p2Choice = '';
var userName = '';
var userNum;
var turn = 1;
var winner = '';
var game = false;

//	Event Listeners

//	This checks each time the players directory is updated and updates the game displays and variables
//	depending on if both players are connected (will need to .remove() onDisconnect() later so that
//	these are updated when a player disconnects (because the players/child will no longer exist).
db.ref('players/').on('value', function(playersSnap) {

	//	Check to see of player 1 exists or not
	if(playersSnap.child('p1').exists()) {

		//	Set game variables to player 1's info
		player1Exists = true;
		player1Object = playersSnap.val().p1;			console.log('p1 object: ' + player1Object);
		p1Choice = playersSnap.val().p1.choice;
		player1Name = playersSnap.val().p1.name;

		//	Update player 1 displays
		$('#name1').text(player1Name);
		$('#one').removeClass('js-hidden');
		$('#missing1').addClass('js-hidden');
		$('#wins1').text(playersSnap.val().p1.wins);
		$('#losses1').text(playersSnap.val().p1.losses);
	} else {

		//	Reset game variables in case player 1 did exist, but has since been removed
		player1 = false;
		player1Object = null;
		player1Name = '';
		p1Choice = '';
		
		//	Update player 1 displays accordingly
		$('#one').addClass('js-hidden');
		$('#missing1').removeClass('js-hidden');
	}

	//	Do all of the above scenarios, but for player 2
	if(playersSnap.child('p2').exists()) {

		//	Set game variables to player 2's info
		player2Exists = true;
		player2object = playersSnap.val().p2;
		player2Name = playersSnap.val().p2.name;
		p2Choice = playersSnap.val().p2.choice;

		//	Update player 2 displays
		$('#name2').text(player2Name);
		$('#two').removeClass('js-hidden');
		$('#missing2').addClass('js-hidden');
		$('#wins2').text(playersSnap.val().p2.wins);
		$('#losses2').text(playersSnap.val().p2.losses);
	} else {

		//	Reset game variables in case player 1 did exist, but has since been removed
		player2 = false;
		player2Object = null;
		player2Name = '';
		p2Choice = '';
		
		//	Update player 2 displays accordingly
		$('#two').addClass('js-hidden');
		$('#missing2').removeClass('js-hidden');
	}
	
	if(!player1Exists && !player2Exists) {
		db.ref('turn').set(0);
	}
	if(!player1Exists || !player2Exists) {
		game = false;
	}

}, function(error) {
	console.log('Error: ' + error.code);
});


$('#play').click(function() {

	if($('#player-input').val().trim() != '') {

		userName = $('#player-input').val().trim();

		if(player1Exists && player2Exists) {
			alert('Game is currently full!');
			//	Clear the name input field
			$('#player-input').val('');
		} else if(player1Exists && !player2Exists) {

			userNum = 2;

			//	Add Player 2 to the DB
			db.ref('players/p2').set({
				name: userName,
				wins: 0,
				losses: 0,
				choice: ''
			});

			//	Set the onDisconnect() for player 2
			db.ref('players/p2').onDisconnect().remove();

			//	Hide the Name input field
			$('.new-player').addClass('js-hidden');

		} else if(!player1Exists) {

			userNum = 1;

			//	Add Player 1 to the DB
			db.ref('players/p1').set({
				name: userName,
				wins: 0,
				losses: 0,
				choice: ''
			});
			
			//	Sets the turn to 1 when Player One is created
//			db.ref('turn').set(1);

			//	Set the onDisconnect() for player 1
			db.ref('players/p1').onDisconnect().remove();

			//	Hide the Name input field
			$('.new-player').addClass('js-hidden');
		}
		if(player1Exists && player2Exists) {
			db.ref('turn').set(1);
			game = true;
		}

	}
});

db.ref('turn').on('value', function(turnSnap) {		console.log('turn: ' + turnSnap.val());

	if(player1Exists && player2Exists) {

		if(turnSnap.val() == 1) {
			turn = 1;				console.log('client turn: ' + turn);
		
			//	Update the game displays for Turn 1 Status
			if(userNum == 1) {
				$('#p1-waiting').addClass('js-hidden');
				$('#choices1').removeClass('js-hidden');
	
				$('#p2-waiting').removeClass('js-hidden');
				$('#choices2').addClass('js-hidden');

			} else if(userNum == 2) {
				$('#p1-waiting').addClass('js-hidden');
				$('#choices1').addClass('js-hidden');
				$('#p2-waiting').removeClass('js-hidden');
				$('#choices2').addClass('js-hidden');
			}

			$('#msg-1').text(player1Name + "'s turn!");
			$('.game-message').removeClass('js-hidden');

		} else if (turnSnap.val() == 2) {				console.log('Player number: ' + userNum);
			if(userNum == 2) {					console.log('still ' + userNum);
				$('#p2-waiting').addClass('js-hidden');
				$('#choices2').removeClass('js-hidden');
//				$('#choices2').removeClass('js-hidden');
//				$('#choices2').attr('class', 'nothing');

				$('#p1-waiting').removeClass('js-hidden');
				$('#choices1').addClass('js-hidden');

			} else if (userNum == 1) {
				$('#p2-waiting').addClass('js-hidden');
				$('#choices2').addClass('js-hidden');
				$('#p1-waiting').removeClass('js-hidden');
				$('#choices1').addClass('js-hidden');
			}

			$('#msg-1').text(player2Name + "'s turn!");
			$('.game-message').removeClass('js-hidden');

		} else if (turnSnap.val() == 0) {
			$('#p1-waiting').removeClass('js-hidden');
			$('#choices1').addClass('js-hidden');
			$('#msg-1').text('Waiting on Players...');
			$('.game-message').removeClass('js-hidden');
			$('#p2-waiting').removeClass('js-hidden');
			$('#choices2').addClass('js-hidden');
		}
	} else if (turnSnap.val() == 0) {
		$('#p1-waiting').removeClass('js-hidden');
		$('#choices1').addClass('js-hidden');
		$('#msg-1').text('Waiting on Players...');
		$('.game-message').removeClass('js-hidden');
		$('#p2-waiting').removeClass('js-hidden');
		$('#choices2').addClass('js-hidden');
	} else {
		db.ref('turn').set(0);
	}
	turn = turnSnap.val();

}, function(error) {
	console.log('Error: ' + error.code);
});

db.ref('players').on('child_removed', function(playerSnap) {
	db.ref('turn').set(0);
}, function(error) {
	console.log('Error: ' + error.code);
});

$('.choice1').click(function() {

	player1Choice = $(this).text();

	db.ref('players/p1').update({
		choice: player1Choice
	});

	turn = 2;
	db.ref('turn').set(turn);
});

$('.choice2').click(function() {

	player2Choice = $(this).text();		console.log(player2Choice + 'turn ' + turn);

	db.ref('players/p2').child('choice').set(				//	possible issue here
		player2Choice
	);

//	db.ref('players/p1').update({
//		choice: player2Choice
//	});

//	turn = 1;
//	db.ref('turn').set(turn);
	resolveGame();				console.log(player2Choice + ' client turn: ' + turn );
});

function resolveGame() {

/*
	$('.results').empty();

	if(player1Object.choice === 'Rock') {
		if(player2Object.choice === 'Rock') {
			winner = 'Nobody';
		} else if(player2Object.choice === 'Paper') {
			winner = player2Name;
		} else if (player2Object.choice === 'Scisscors') {
			winner = player1Name;
		}
	} else if(player1Object.choice === 'Paper') {
		if(player2Object.choice === 'Rock') {
			winner = player1Name;
		} else if(player2Object.choice === 'Paper') {
			winner = 'Nobody';
		} else if(player2Object.choice === 'Scisscors') {
			winner = player2Name;
		}
	} else if(player1Object.choice === 'Scisscors') {
		if(player2Object.choice === 'Rock') {
			winner = player2Name;
		} else if(player2Object.choice === 'Paper') {
			winner = player1Name;
		} else if(player2Object.choice === 'Scisscors') {
			winner = 'Nobody';
		}
	}
*/

	$('.results').empty();		console.log('p1: ' + p1Choice + '; p2: ' + p2Choice);

	if(p1Choice === 'Rock') {
		if(p2Choice === 'Rock') {
			winner = 'Nobody';
		} else if(p2Choice === 'Paper') {
			winner = player2Name;
		} else if (p2Choice === 'Scissors') {
			winner = player1Name;
		}
	} else if(p1Choice === 'Paper') {
		if(p2Choice === 'Rock') {
			winner = player1Name;
		} else if(p2Choice === 'Paper') {
			winner = 'Nobody';
		} else if(p2Choice === 'Scissors') {
			winner = player2Name;
		}
	} else if(p1Choice === 'Scissors') {
		if(p2Choice === 'Rock') {
			winner = player2Name;
		} else if(p2Choice === 'Paper') {
			winner = player1Name;
		} else if(p2Choice === 'Scissors') {
			winner = 'Nobody';
		}
	}							console.log('winner: ' + winner);
	
	db.ref('result').set({					//	possible issue here.
		winner: ''
	});
	db.ref('result').set({					//	possible issue here.
		winner: winner
	});
//	db.ref('result').onDisconnect().remove();
}

db.ref('result').on('value', function(resultSnap) {		console.log('results updated; turn: ' + turn);		// This is not reliably being called

	if(turn == 2 && resultSnap.val().winner != '') {
		var choice1 = $('<div>');
		choice1.text(player1Name + ' chose ' + p1Choice + '!');
		var choice2 = $('<div>');
		choice2.text(player2Name + ' chose ' + p2Choice + '!');
		var result = $('<h3>');
		result.text(resultSnap.val().winner + ' wins!');

		$('.results').append(choice1, choice2, result);

		setTimeout(function() {
			$('.results').empty();
		}, 3500);
		
		turn = 1;
		db.ref('turn').set(turn);
	}

}, function(error) {
	console.log('Error: ' + error.code);
});
</script>

</html>